      _  __  _______   _____     ____     _____
     / |/ /_/_  __/ | / /_  |___/ __/__  / ___/
    /    / -_) /  | |/ / __/___/\ \/ _ \/ /__
   /_/|_/\__/_/   |___/____/  /___/\___/\___/
        Copyright (c) 2016-2020 / EnjoyDigital
              Powered by Migen & LiteX

[> Getting started
------------------

Existing makefile targets assume that you have a separate testing Linux PC that has NeTV2 board plugged in and that it can be reached via SSH from your development PC.

It is assumed that you're using NeTV2 board with xc7a35t. If you're using the variant with xc7a100t, set PART variable:
    export PART=xc7a100t

Currently only HDMI source that was succesfully captured is Numato Opsis HDMI output but by using Opsis as a HDMI repeater other sources can be captured (1280x720p60 output from a PC works fine).
Additionally only RX0 HDMI input is supported by the current design. TX0 HDMI output is also supported by the design.

Building bitstream:

1. Prepare virtualenv:
    make venv/create
    source venv/bin/activate
    make venv/install

2. Source Vivado configuration (if not already sourced):
    source /opt/Xilinx/Vivado/2019.2/settings64.sh

3. Build the bitstream:
    make gateware/build

4. Bitstream should be located in:
    build/gateware/top.bit

Loading bitstream:

1. Connect to NeTV2 board using JTAG (ARM-USB-TINY-H JTAG adapter was used)
2. Plug NeTV2 board into test PC
3. Turn on test PC
4. Stop test PC in bootloader
5. Load bitstream:
    make gateware/load

6. Continue booting the test PC
7. lspci in linux should show:
    Memory controller: Xilinx Corporation Device 7021

Building and loading kernel module:

1. Setup enviroment:
    export IP_ADDR "<test PC IP address>"
    export LOGIN "<test PC ssh username>"

2. Build kernel module on the test PC:
    make module/build

3. Kernel module should be located in:
    /lib/modules/\`uname -r\`/litepcie.ko

4. Update list of module dependencies:
    depmod -A

5. Load kernel module:
    modprobe litepcie

6. Check if module was loaded:
    lsmod | grep litepcie

Reloading kernel module:

1. Setup enviroment

2. Adjust the following line in makefile to point to the correct PCIe device (this needs to be adjusted for each test PC used):
    echo 1 | sudo tee /sys/bus/pci/devices/0000\:02\:00.0/remove

3. Reload kernel module:
    make host/reload

Gstreamer:

1. Setup enviroment

2. Start gstreamer with:
    make host/out # for HDMI output (gstreamer's videotestsrc)
    make host/gst # for HDMI input

3. Stop gstreamer with:
    make host/stop

[> Status
---------
# FIXME

[> Contact
----------
E-mail: florent@enjoy-digital.fr
